library(tidyr)
library(dplyr)
library(ordinal)
library(emmeans)

framework <- "gds"
  
score_file <- paste0("data/scores-", framework, ".csv")
scores <- read.csv(file = score_file, stringsAsFactors = FALSE)
  
areas_file <- paste0("data/areas-key-", framework, ".csv")
areas <- read.csv(file = areas_file, stringsAsFactors = FALSE)
  
# Convert scores to long
# Skip Institution
# During pivot, drop data from columns with higher area name, as they have no 
# data
area_prefix <- paste0(toupper(x = framework), ".")
scores_long <- scores %>%
pivot_longer(cols = starts_with(match = area_prefix),
      names_to = "Subarea", 
      values_to = "Score",
      values_drop_na = TRUE) %>%
      select(-Institution)
  
# Need to assign Area for each subarea.
scores_long <- merge(x = scores_long, 
      y = areas[, c("Area", "Key")],
      by.x = "Subarea",
      by.y = "Key")
  
# Explicitly cast Area as a factor for subsequent assumption tests
scores_long$Area <- factor(x = scores_long$Area)
  
# Ordinal package is expecting a factor for the response variable
scores_long$ScoreOrdinal <- as.factor(scores_long$Score)
  
# Run mixed model: Area as fixed, program as random; 
# setting threshold = "equidistant" avoids downstream errors in post-hoc tests
  scores_clmm <- ordinal::clmm(ScoreOrdinal ~ Area + (1|Program),
        data = scores_long,
        threshold = "equidistant") 

# Run post-hoc pairwise comparisons
emm <- emmeans(scores_clmm, ~ Area)
# Extract pairwise comparison p-values
pairs(emm, adjust = "tukey")
